<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/><link href="/site.webmanifest" rel="manifest"/><link href="https://cdn.jsdelivr.net/npm/uikit@3.15.24/dist/css/uikit.min.css" rel="stylesheet"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/><script src="https://cdn.jsdelivr.net/npm/uikit@3.15.24/dist/js/uikit.min.js"></script><script src="https://cdn.jsdelivr.net/npm/uikit@3.15.24/dist/js/uikit-icons.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-okaidia.min.css" rel="stylesheet"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-python.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-bash.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-docker.min.js"></script><title>Using multi-stage docker containers in CI</title></head><body><div><div uk-sticky="media: 960; sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky"><nav class="uk-navbar-container uk-margin uk-dark uk-navbar-transparent uk-box-shadow-small uk-background-default" uk-navbar=""><div class="uk-navbar-left uk-margin-medium-left"><ul class="uk-navbar-nav"><li class="uk-navbar-item"><a #00d5ff"="" href="https://github.com/maximdanilchenko" uk-icon="icon: github"></a></li><li class="uk-navbar-item"><a href="https://linkedin.com/in/maximdanilchenko" uk-icon="icon: linkedin"></a></li><li class="uk-navbar-item"><a href="https://instagram.com/dmaxdev" uk-icon="icon: instagram"></a></li><li class="uk-navbar-item"><a href="https://soundcloud.com/maxdmg" uk-icon="icon: soundcloud"></a></li></ul></div><div class="uk-navbar-right uk-margin-medium-right"><ul class="uk-navbar-nav"><li class="uk-navbar-item uk-margin-small-right"><a href="." uk-icon="icon: home"></a></li></ul></div></nav></div><div class="uk-container uk-margin-large-bottom uk-margin-small uk-animation-slide-top-small"><div class="uk-grid-small" uk-grid=""><div class="uk-width-1-6 uk-visible@l"></div><div class="uk-width-expand"><div class="uk-container uk-container-small uk-position-relative"><div><h1 class="uk-heading-primary uk-margin">Using multi-stage docker containers in CI</h1><p><em>6 Mar 2019</em></p><p>Multi-stage builds are very useful to optimize usage of Dockerfiles for CI and for development process. You can make multiple stages using <code>FROM</code> statements, inherit them by name (given with <code>as name</code> statement) or selectively copy artifacts from one stage to another.</p><p>You can see official <a href="https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds">documentation</a> for example about using multi-stage builds for copying artifacts.</p><p>But one of the my favourite use-case is dividing Dockerfile on stages for different build environments, like test, dev, prod and so on, like this:</p><pre><code class="language-docker">FROM python:3.6-alpine3.9 as builder
ADD requirements.txt /app/
WORKDIR /app
RUN pip3 install --upgrade -r requirements.txt

FROM builder as test
ADD dev-requirements.txt /app/
RUN pip3 install --upgrade -r dev-requirements.txt
EXPOSE 8020
CMD [ "python", "./main.py" ]

FROM builder as deploy
ADD . /app
CMD [ "python", "./main.py" ]
</code></pre><p>Next we can build image from <code>test</code>, <code>deploy</code> or even <code>builder</code> stage:</p><pre><code class="language-bash">&gt; docker build --target test --tag tester
</code></pre><hr/><p>If you find something wrong in this post fill free to create issues <a href="https://github.com/maximdanilchenko/dmax.blog/issues">here</a>.</p><hr/><a href="#" uk-scroll="" uk-totop=""></a></div></div></div><div class="uk-width-1-6 uk-visible@l"><div uk-sticky="offset: 100"><div><ul class="uk-nav-default" uk-nav=""><li class="uk-text-lead">Other posts</li><li><a href="./how_to_easily_build_modern_web_apis_with_python_and_aiohttp.html">How to easily build modern web APIs with python and aiohttp</a></li></ul></div></div></div></div></div></div></body></html>